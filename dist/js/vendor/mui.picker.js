/**
 * 选择列表插件
 * varstion 2.0.0
 * by Houfeng
 * Houfeng@DCloud.io
 */
!function($,window,document,undefined){var MAX_EXCEED=30,VISIBLE_RANGE=90,DEFAULT_ITEM_HEIGHT=40,BLUR_WIDTH=10,rad2deg=$.rad2deg=function(rad){return rad/(Math.PI/180)},platform=($.deg2rad=function(deg){return deg*(Math.PI/180)},navigator.platform.toLowerCase()),userAgent=navigator.userAgent.toLowerCase(),isIos=(userAgent.indexOf("iphone")>-1||userAgent.indexOf("ipad")>-1||userAgent.indexOf("ipod")>-1)&&(platform.indexOf("iphone")>-1||platform.indexOf("ipad")>-1||platform.indexOf("ipod")>-1),Picker=$.Picker=function(holder,options){var self=this;self.holder=holder,self.options=options||{},self.init(),self.initInertiaParams(),self.calcElementItemPostion(!0),self.bindEvent()};Picker.prototype.findElementItems=function(){var self=this;return self.elementItems=[].slice.call(self.holder.querySelectorAll("li")),self.elementItems},Picker.prototype.init=function(){var self=this;self.list=self.holder.querySelector("ul"),self.findElementItems(),self.height=self.holder.offsetHeight,self.r=self.height/2-BLUR_WIDTH,self.d=2*self.r,self.itemHeight=self.elementItems.length>0?self.elementItems[0].offsetHeight:DEFAULT_ITEM_HEIGHT,self.itemAngle=parseInt(self.calcAngle(.8*self.itemHeight)),self.hightlightRange=self.itemAngle/2,self.visibleRange=VISIBLE_RANGE,self.beginAngle=0,self.beginExceed=self.beginAngle-MAX_EXCEED,self.list.angle=self.beginAngle,isIos&&(self.list.style.webkitTransformOrigin="center center "+self.r+"px")},Picker.prototype.calcElementItemPostion=function(andGenerateItms){var self=this;andGenerateItms&&(self.items=[]),self.elementItems.forEach(function(item){var index=self.elementItems.indexOf(item);self.endAngle=self.itemAngle*index,item.angle=self.endAngle,item.style.webkitTransformOrigin="center center -"+self.r+"px",item.style.webkitTransform="translateZ("+self.r+"px) rotateX("+-self.endAngle+"deg)"}),self.endExceed=self.endAngle+MAX_EXCEED,self.calcElementItemVisibility(self.beginAngle)},Picker.prototype.calcAngle=function(c){var self=this,a=b=parseFloat(self.r);
//直径的整倍数部分直接乘以 180
c=Math.abs(c);//只算角度不关心正否值
var intDeg=180*parseInt(c/self.d);c%=self.d;
//余弦
var cosC=(a*a+b*b-c*c)/(2*a*b),angleC=intDeg+rad2deg(Math.acos(cosC));return angleC},Picker.prototype.calcElementItemVisibility=function(angle){var self=this;self.elementItems.forEach(function(item){var difference=Math.abs(item.angle-angle);difference<self.hightlightRange?item.classList.add("highlight"):difference<self.visibleRange?(item.classList.add("visible"),item.classList.remove("highlight")):(item.classList.remove("highlight"),item.classList.remove("visible"))})},Picker.prototype.setAngle=function(angle){var self=this;self.list.angle=angle,self.list.style.webkitTransform="perspective(1000px) rotateY(0deg) rotateX("+angle+"deg)",self.calcElementItemVisibility(angle)},Picker.prototype.bindEvent=function(){var self=this,lastAngle=0,startY=null,isPicking=!1;self.holder.addEventListener($.EVENT_START,function(event){isPicking=!0,event.preventDefault(),self.list.style.webkitTransition="",startY=(event.changedTouches?event.changedTouches[0]:event).pageY,lastAngle=self.list.angle,self.updateInertiaParams(event,!0)},!1),self.holder.addEventListener($.EVENT_END,function(event){isPicking=!1,event.preventDefault(),self.startInertiaScroll(event)},!1),self.holder.addEventListener($.EVENT_CANCEL,function(event){isPicking=!1,event.preventDefault(),self.startInertiaScroll(event)},!1),self.holder.addEventListener($.EVENT_MOVE,function(event){if(isPicking){event.preventDefault();var endY=(event.changedTouches?event.changedTouches[0]:event).pageY,dragRange=endY-startY,dragAngle=self.calcAngle(dragRange),newAngle=dragRange>0?lastAngle-dragAngle:lastAngle+dragAngle;newAngle>self.endExceed&&(newAngle=self.endExceed),newAngle<self.beginExceed&&(newAngle=self.beginExceed),self.setAngle(newAngle),self.updateInertiaParams(event)}},!1),
//--
self.list.addEventListener("tap",function(event){elementItem=event.target,"LI"==elementItem.tagName&&self.setSelectedIndex(self.elementItems.indexOf(elementItem),200)},!1)},Picker.prototype.initInertiaParams=function(){var self=this;self.lastMoveTime=0,self.lastMoveStart=0,self.stopInertiaMove=!1},Picker.prototype.updateInertiaParams=function(event,isStart){var self=this,point=event.changedTouches?event.changedTouches[0]:event;if(isStart)self.lastMoveStart=point.pageY,self.lastMoveTime=event.timeStamp||Date.now(),self.startAngle=self.list.angle;else{var nowTime=event.timeStamp||Date.now();nowTime-self.lastMoveTime>300&&(self.lastMoveTime=nowTime,self.lastMoveStart=point.pageY)}self.stopInertiaMove=!0},Picker.prototype.startInertiaScroll=function(event){var self=this,point=event.changedTouches?event.changedTouches[0]:event,nowTime=event.timeStamp||Date.now(),v=(point.pageY-self.lastMoveStart)/(nowTime-self.lastMoveTime),dir=v>0?-1:1,deceleration=6e-4*dir*-1,duration=Math.abs(v/deceleration),dist=v*duration/2,startAngle=self.list.angle,distAngle=self.calcAngle(dist)*dir,srcDistAngle=distAngle;
//----
//----
return startAngle+distAngle<self.beginExceed&&(distAngle=self.beginExceed-startAngle,duration=duration*(distAngle/srcDistAngle)*.6),startAngle+distAngle>self.endExceed&&(distAngle=self.endExceed-startAngle,duration=duration*(distAngle/srcDistAngle)*.6),0==distAngle?void self.endScroll():void self.scrollDistAngle(nowTime,startAngle,distAngle,duration)},Picker.prototype.scrollDistAngle=function(nowTime,startAngle,distAngle,duration){var self=this;self.stopInertiaMove=!1,function(nowTime,startAngle,distAngle,duration){var frameInterval=13,stepCount=duration/frameInterval,stepIndex=0;!function inertiaMove(){if(!self.stopInertiaMove){var newAngle=self.quartEaseOut(stepIndex,startAngle,distAngle,stepCount);return self.setAngle(newAngle),stepIndex++,stepIndex>stepCount-1||newAngle<self.beginExceed||newAngle>self.endExceed?void self.endScroll():void setTimeout(inertiaMove,frameInterval)}}()}(nowTime,startAngle,distAngle,duration)},Picker.prototype.quartEaseOut=function(t,b,c,d){return-c*((t=t/d-1)*t*t*t-1)+b},Picker.prototype.endScroll=function(){var self=this;if(self.list.angle<self.beginAngle)self.list.style.webkitTransition="150ms ease-out",self.setAngle(self.beginAngle);else if(self.list.angle>self.endAngle)self.list.style.webkitTransition="150ms ease-out",self.setAngle(self.endAngle);else{var index=parseInt((self.list.angle/self.itemAngle).toFixed(0));self.list.style.webkitTransition="100ms ease-out",self.setAngle(self.itemAngle*index)}self.triggerChange()},Picker.prototype.triggerChange=function(force){var self=this;setTimeout(function(){var index=self.getSelectedIndex(),item=self.items[index];!$.trigger||index==self.lastIndex&&force!==!0||$.trigger(self.holder,"change",{index:index,item:item}),self.lastIndex=index,"function"==typeof force&&force()},0)},Picker.prototype.correctAngle=function(angle){var self=this;return angle<self.beginAngle?self.beginAngle:angle>self.endAngle?self.endAngle:angle},Picker.prototype.setItems=function(items){var self=this;self.items=items||[];var buffer=[];self.items.forEach(function(item){null!==item&&item!==undefined&&buffer.push("<li>"+(item.text||item)+"</li>")}),self.list.innerHTML=buffer.join(""),self.findElementItems(),self.calcElementItemPostion(),self.setAngle(self.correctAngle(self.list.angle)),self.triggerChange(!0)},Picker.prototype.getItems=function(){var self=this;return self.items},Picker.prototype.getSelectedIndex=function(){var self=this;return parseInt((self.list.angle/self.itemAngle).toFixed(0))},Picker.prototype.setSelectedIndex=function(index,duration,callback){var self=this;self.list.style.webkitTransition="";var angle=self.correctAngle(self.itemAngle*index);if(duration&&duration>0){var distAngle=angle-self.list.angle;self.scrollDistAngle(Date.now(),self.list.angle,distAngle,duration)}else self.setAngle(angle);self.triggerChange(callback)},Picker.prototype.getSelectedItem=function(){var self=this;return self.items[self.getSelectedIndex()]},/********************************************************************************************************/
Picker.prototype.getSelectedValue=function(){},/********************************************************************************************************/
Picker.prototype.getSelectedText=function(){},Picker.prototype.setSelectedValue=function(value,duration,callback){var self=this;for(var index in self.items){var item=self.items[index];if(item.value==value)return void self.setSelectedIndex(index,duration,callback)}},$.fn&&($.fn.picker=function(options){
//遍历选择的元素
return this.each(function(i,element){if(!element.picker)if(options)element.picker=new Picker(element,options);else{var optionsText=element.getAttribute("data-picker-options"),_options=optionsText?JSON.parse(optionsText):{};element.picker=new Picker(element,_options)}}),this[0]?this[0].picker:null},
//自动初始化
$.ready(function(){$(".mui-picker").picker()}))}(window.mui||window,window,document,void 0);